name: Construir, Enviar Imagens Docker e Fazer Deploy no Kubernetes

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Baixar o cÃ³digo do repositÃ³rio
      - name: Baixar cÃ³digo do repositÃ³rio
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Configurar Docker Buildx (para builds otimizados)
      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3ï¸âƒ£ Fazer login no Docker Hub
      - name: Fazer login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4ï¸âƒ£ Construir e enviar imagem do Frontend (Angular)
      - name: Construir e enviar imagem do Frontend (Angular)
        uses: docker/build-push-action@v6
        with:
          context: ./client
          push: true
          tags: guisilva1k2k/frontend-ecommerce:dev
          no-cache: true
          pull: true

      # 5ï¸âƒ£ Instalar kubectl (CLI do Kubernetes)
      - name: Instalar kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      # 6ï¸âƒ£ Configurar credenciais do Kubernetes
      - name: Configurar credenciais do Kubernetes
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 --decode > $HOME/.kube/config
          echo "âœ… kubeconfig aplicado com sucesso!"
          kubectl cluster-info --insecure-skip-tls-verify || echo "âš ï¸ Aviso: verifique o acesso ao cluster"

      # 7ï¸âƒ£ Aplicar os manifestos do Kubernetes
      - name: Aplicar manifestos no cluster
        run: |
          echo "ğŸ“¦ Aplicando manifestos no cluster..."
          kubectl apply -k k8s --validate=false --insecure-skip-tls-verify
          echo "âœ… Manifestos aplicados com sucesso!"

      # 8ï¸âƒ£ Atualizar imagens dos deployments
      - name: Atualizar imagens no Kubernetes
        run: |
          echo "ğŸ” Atualizando imagens no cluster..."
          kubectl set image deployment/backend app=pedrobrantis/backend:deploy -n app-demo --insecure-skip-tls-verify
          kubectl set image deployment/frontend web=guisilva1k2k/frontend-ecommerce:deploy -n app-demo --insecure-skip-tls-verify
          echo "âœ… Imagens atualizadas com sucesso!"

      # 9ï¸âƒ£ Verificar o status dos deployments
      - name: Verificar status dos deployments
        run: |
          echo "ğŸ•“ Aguardando os pods ficarem prontos..."
          kubectl rollout status deployment/backend -n app-demo --insecure-skip-tls-verify
          kubectl rollout status deployment/frontend -n app-demo --insecure-skip-tls-verify
          echo "âœ… Deploy concluÃ­do com sucesso!"

      # ğŸ”Ÿ Importar banco de dados no MySQL
      - name: Importar banco de dados no MySQL
        run: |
          echo "ğŸš€ Preparando dump SQL para importaÃ§Ã£o..."
          kubectl delete job mysql-import -n app-demo --ignore-not-found=true --insecure-skip-tls-verify

          # Cria o ConfigMap com o conteÃºdo do dump (sem precisar alterar o YAML no repo)
          kubectl create configmap sql-dump-config \
            --from-file=sql_dump.sql=backend/sql_dump.sql \
            -n app-demo --insecure-skip-tls-verify \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "ğŸ“¦ Aplicando job de importaÃ§Ã£o MySQL..."
          kubectl apply -f k8s/50-job-mysql-import.yaml -n app-demo --insecure-skip-tls-verify

          echo "â³ Aguardando conclusÃ£o do job..."
          kubectl wait --for=condition=complete job/mysql-import -n app-demo --timeout=120s --insecure-skip-tls-verify || \
          (echo "âš ï¸ O job falhou!" && kubectl logs job/mysql-import -n app-demo && exit 1)

          echo "âœ… Dump importado com sucesso!"

      # ğŸŒ Mostrar URL pÃºblica
      - name: Mostrar URL pÃºblica
        run: |
          echo "ğŸŒ Acesse o frontend em:"
          echo "ğŸ‘‰ http://3.143.251.114:30080"
