name: Construir, Enviar Imagens Docker e Fazer Deploy no Kubernetes

on:
  push:
    branches:
      - master  # Modifiquei para 'master', caso o seu branch principal seja 'master' (caso contrÃ¡rio, altere para 'main')

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Baixar o cÃ³digo do repositÃ³rio
      - name: Baixar cÃ³digo do repositÃ³rio
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Configurar Docker Buildx (para builds otimizados)
      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3ï¸âƒ£ Fazer login no Docker Hub
      - name: Fazer login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4ï¸âƒ£ Construir e enviar imagem do Frontend (Angular)
      - name: Construir e enviar imagem do Frontend (Angular)
        uses: docker/build-push-action@v6
        with:
          context: ./client
          push: true
          tags: guisilva1k2k/frontend-ecommerce:dev  # NÃ£o alterei para manter a consistÃªncia com seu exemplo
          no-cache: true
          pull: true

      # 5ï¸âƒ£ Instalar kubectl (CLI do Kubernetes)
      - name: Instalar kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      # 6ï¸âƒ£ Configurar credenciais de acesso ao Kubernetes
      - name: Configurar credenciais do Kubernetes
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 --decode > $HOME/.kube/config
          echo "âœ… kubeconfig aplicado com sucesso!"
          kubectl cluster-info --insecure-skip-tls-verify || echo "âš ï¸ Aviso: verifique o acesso ao cluster"

      # 7ï¸âƒ£ Aplicar os manifestos do Kubernetes (inclui backend, frontend, mysql e configmaps)
      - name: Aplicar manifestos do Kubernetes
        run: |
          echo "ğŸ“¦ Aplicando manifestos no cluster..."
          kubectl apply -k k8s --validate=false --insecure-skip-tls-verify
          echo "âœ… Manifestos aplicados com sucesso!"

      # 8ï¸âƒ£ Atualizar imagens dos deployments
      - name: Atualizar imagens no Kubernetes
        run: |
          echo "ğŸ” Atualizando imagens no cluster..."
          kubectl set image deployment/backend app=pedrobrantis/backend:deploy -n app-demo --insecure-skip-tls-verify
          kubectl set image deployment/frontend web=guisilva1k2k/frontend-ecommerce:deploy -n app-demo --insecure-skip-tls-verify
          echo "âœ… Imagens atualizadas com sucesso!"

      # 9ï¸âƒ£ Verificar o status dos deployments (garantir que subiram)
      - name: Verificar status dos deployments
        run: |
          echo "ğŸ•“ Aguardando os pods ficarem prontos..."
          kubectl rollout status deployment/backend -n app-demo --insecure-skip-tls-verify
          kubectl rollout status deployment/frontend -n app-demo --insecure-skip-tls-verify
          echo "âœ… Deploy concluÃ­do com sucesso!"

      # ğŸ”Ÿ Rodar a Job de importaÃ§Ã£o do dump SQL
      - name: Rodar Job de importaÃ§Ã£o do SQL no MySQL
        run: |
          echo "ğŸ“¥ Rodando importaÃ§Ã£o do SQL dump no MySQL..."
          kubectl delete job mysql-import -n app-demo --ignore-not-found --insecure-skip-tls-verify
          kubectl apply -f k8s/50-job-mysql-import.yaml --validate=false --insecure-skip-tls-verify
          echo "âœ… Job de importaÃ§Ã£o aplicada!"

      # ğŸ” Mostrar URL pÃºblica do frontend
      - name: Mostrar URL pÃºblica
        run: |
          echo "ğŸŒ Acesse o frontend em:"
          echo "ğŸ‘‰ http://3.143.251.114:30080"  # NÃ£o alterei, pois essa parece ser a URL de produÃ§Ã£o
